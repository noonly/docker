limit_req_zone $cookie_NOONLY_ACCESS zone=session_limit:30m rate=300r/s;
limit_req_zone $binary_remote_addr zone=token_limit:30m rate=200r/s;

proxy_temp_path /tmp/proxy_temp_dir;
proxy_cache_path /tmp/proxy_cache_dirlevels=1:2 keys_zone=cache_one:200m inactive=1d max_size=30g;


upstream AccessInterface {
	least_conn;
	server  172.17.0.12:8080 max_fails=3 fail_timeout=60 weight=1;
}
upstream Authority {
	least_conn;
	server  172.17.0.12:8080 max_fails=3 fail_timeout=60 weight=1;
}
upstream Back {
	least_conn;
	server  172.17.0.17:8080 max_fails=3 fail_timeout=60 weight=1;
}
upstream Class {
	least_conn;
	server  172.17.0.13:8080 max_fails=3 fail_timeout=60 weight=1;
}
upstream GraduatesInfo {
	least_conn;
	server  172.17.0.15:8080 max_fails=3 fail_timeout=60 weight=1;
}
upstream Info {
	least_conn;
	server  172.17.0.16:8080 max_fails=3 fail_timeout=60 weight=1;
}
upstream Login {
	least_conn;
	server  172.17.0.17:8080 max_fails=3 fail_timeout=60 weight=1;
}
upstream Medias {
	least_conn;
	server  172.17.0.26:8080 max_fails=3 fail_timeout=60 weight=1;
}
upstream Oeac {
	least_conn;
	server  172.17.0.18:8080 max_fails=3 fail_timeout=60 weight=1;
}
upstream Question {
	least_conn;
	server  172.17.0.21:8080 max_fails=3 fail_timeout=60 weight=1;
}
upstream QuestionPrivilege {
	least_conn;
	server  172.17.0.20:8080 max_fails=3 fail_timeout=60 weight=1;
}
upstream RecordController {
	least_conn;
	server  172.17.0.22:8080 max_fails=3 fail_timeout=60 weight=1;
}
upstream Schedules {
	least_conn;
	server  172.17.0.23:8080 max_fails=3 fail_timeout=60 weight=1;
}
upstream StdImportExport {
	least_conn;
	server  172.17.0.25:8080 max_fails=3 fail_timeout=60 weight=1;
}
upstream SupperManage {
	least_conn;
	server  172.17.0.24:8080 max_fails=3 fail_timeout=60 weight=1;
}
upstream TestController {
	least_conn;
	server  172.17.0.14:8080 max_fails=3 fail_timeout=60 weight=1;
}
upstream TestPlan {
	least_conn;
	server  172.17.0.19:8080 max_fails=3 fail_timeout=60 weight=1;
}
upstream Update {
	least_conn;
	server  172.17.0.25:8080 max_fails=3 fail_timeout=60 weight=1;
}
upstream Video {
	least_conn;
	server 127.0.0.1:65535;

}
upstream admin {
	least_conn;
	server  172.17.0.6:80 max_fails=3 fail_timeout=60 weight=1;server  172.17.0.28:80 max_fails=3 fail_timeout=60 weight=1;
}
upstream afterLoginController {
	least_conn;
	server  172.17.0.17:8080 max_fails=3 fail_timeout=60 weight=1;
}
upstream appInfo {
	least_conn;
	server 127.0.0.1:65535;

}
upstream appMessage {
	least_conn;
	server  172.17.0.11:8080 max_fails=3 fail_timeout=60 weight=1;
}
upstream indexController {
	least_conn;
	server  172.17.0.17:8080 max_fails=3 fail_timeout=60 weight=1;
}
upstream public {
	least_conn;
	server  172.17.0.6:80 max_fails=3 fail_timeout=60 weight=1;server  172.17.0.28:80 max_fails=3 fail_timeout=60 weight=1;
}
upstream webroot {
	least_conn;
	server  172.17.0.7:6379 max_fails=3 fail_timeout=60 weight=1;
}
upstream www {
	least_conn;
	server  172.17.0.5:6379 max_fails=3 fail_timeout=60 weight=1;
}
upstream zuxia {
	least_conn;
	server  172.17.0.28:80 max_fails=3 fail_timeout=60 weight=1;
}


server {
	listen 80; 
	location ~* \.mp4$ {
		rewrite_by_lua_file "/usr/local/openresty/nginx/conf/conf.d/rewitre_token_check.lua";
        	root /video/;
		limit_rate 350k;
	}

	location ~* \.(cur|gif|css|js|png|jpg|woff) {
		limit_req zone=session_limit burst=5;
		rewrite_by_lua_file "/usr/local/openresty/nginx/conf/conf.d/rewitre_token_check.lua";
		proxy_pass http://public;
		proxy_cache cache_one;
	}

	location =/ {
		#limit_req zone=session_limit burst=5;
		rewrite_by_lua_file "/usr/local/openresty/nginx/conf/conf.d/access_token_check.lua";
		#rewrite ^(.*)$ /zuxia/index.html last;
	}

	location /AccessInterface/ {
		add_header Cache-Control no-store;
		#limit_req zone=session_limit burst=5;
		rewrite_by_lua_file "/usr/local/openresty/nginx/conf/conf.d/rewitre_token_check.lua";
		access_by_lua_file "/usr/local/openresty/nginx/conf/conf.d/access_session.lua";
		proxy_pass http://AccessInterface;
		client_max_body_size    1000m;
		proxy_cache cache_one;
		limit_rate 200k;
  	}
	location /Authority/ {
		add_header Cache-Control no-store;
		#limit_req zone=session_limit burst=5;
		rewrite_by_lua_file "/usr/local/openresty/nginx/conf/conf.d/rewitre_token_check.lua";
		access_by_lua_file "/usr/local/openresty/nginx/conf/conf.d/access_session.lua";
		proxy_pass http://Authority;
		client_max_body_size    1000m;
		proxy_cache cache_one;
		limit_rate 200k;
  	}
	location /Back/ {
		add_header Cache-Control no-store;
		#limit_req zone=session_limit burst=5;
		rewrite_by_lua_file "/usr/local/openresty/nginx/conf/conf.d/rewitre_token_check.lua";
		access_by_lua_file "/usr/local/openresty/nginx/conf/conf.d/access_session.lua";
		proxy_pass http://Back;
		client_max_body_size    1000m;
		proxy_cache cache_one;
		limit_rate 200k;
  	}
	location /Class/ {
		add_header Cache-Control no-store;
		#limit_req zone=session_limit burst=5;
		rewrite_by_lua_file "/usr/local/openresty/nginx/conf/conf.d/rewitre_token_check.lua";
		access_by_lua_file "/usr/local/openresty/nginx/conf/conf.d/access_session.lua";
		proxy_pass http://Class;
		client_max_body_size    1000m;
		proxy_cache cache_one;
		limit_rate 200k;
  	}
	location /GraduatesInfo/ {
		add_header Cache-Control no-store;
		#limit_req zone=session_limit burst=5;
		rewrite_by_lua_file "/usr/local/openresty/nginx/conf/conf.d/rewitre_token_check.lua";
		access_by_lua_file "/usr/local/openresty/nginx/conf/conf.d/access_session.lua";
		proxy_pass http://GraduatesInfo;
		client_max_body_size    1000m;
		proxy_cache cache_one;
		limit_rate 200k;
  	}
	location /Info/ {
		add_header Cache-Control no-store;
		#limit_req zone=session_limit burst=5;
		rewrite_by_lua_file "/usr/local/openresty/nginx/conf/conf.d/rewitre_token_check.lua";
		access_by_lua_file "/usr/local/openresty/nginx/conf/conf.d/access_session.lua";
		proxy_pass http://Info;
		client_max_body_size    1000m;
		proxy_cache cache_one;
		limit_rate 200k;
  	}
	location /Login/ {
		add_header Cache-Control no-store;
		#limit_req zone=session_limit burst=5;
		rewrite_by_lua_file "/usr/local/openresty/nginx/conf/conf.d/rewitre_token_check.lua";
		access_by_lua_file "/usr/local/openresty/nginx/conf/conf.d/access_session.lua";
		proxy_pass http://Login;
		#body_filter_by_lua 'ngx.log(ngx.ERR, ngx.var.cookie_NOONLYSESSION .. ngx.arg[1])';
		client_max_body_size    1000m;
		proxy_cache cache_one;
		limit_rate 200k;
  	}
	location /Medias/ {
		add_header Cache-Control no-store;
		#limit_req zone=session_limit burst=5;
		rewrite_by_lua_file "/usr/local/openresty/nginx/conf/conf.d/rewitre_token_check.lua";
		access_by_lua_file "/usr/local/openresty/nginx/conf/conf.d/access_session.lua";
		proxy_pass http://Medias;
		client_max_body_size    1000m;
		proxy_cache cache_one;
		limit_rate 200k;
  	}
	location /Oeac/ {
		add_header Cache-Control no-store;
		#limit_req zone=session_limit burst=5;
		rewrite_by_lua_file "/usr/local/openresty/nginx/conf/conf.d/rewitre_token_check.lua";
		access_by_lua_file "/usr/local/openresty/nginx/conf/conf.d/access_session.lua";
		proxy_pass http://Oeac;
		client_max_body_size    1000m;
		proxy_cache cache_one;
		limit_rate 200k;
  	}
	location /Question/ {
		add_header Cache-Control no-store;
		#limit_req zone=session_limit burst=5;
		rewrite_by_lua_file "/usr/local/openresty/nginx/conf/conf.d/rewitre_token_check.lua";
		access_by_lua_file "/usr/local/openresty/nginx/conf/conf.d/access_session.lua";
		proxy_pass http://Question;
		client_max_body_size    1000m;
		proxy_cache cache_one;
		limit_rate 200k;
  	}
	location /QuestionPrivilege/ {
		add_header Cache-Control no-store;
		#limit_req zone=session_limit burst=5;
		rewrite_by_lua_file "/usr/local/openresty/nginx/conf/conf.d/rewitre_token_check.lua";
		access_by_lua_file "/usr/local/openresty/nginx/conf/conf.d/access_session.lua";
		proxy_pass http://QuestionPrivilege;
		client_max_body_size    1000m;
		proxy_cache cache_one;
		limit_rate 200k;
  	}
	location /RecordController/ {
		add_header Cache-Control no-store;
		#limit_req zone=session_limit burst=5;
		rewrite_by_lua_file "/usr/local/openresty/nginx/conf/conf.d/rewitre_token_check.lua";
		access_by_lua_file "/usr/local/openresty/nginx/conf/conf.d/access_session.lua";
		proxy_pass http://RecordController;
		client_max_body_size    1000m;
		proxy_cache cache_one;
		limit_rate 200k;
  	}
	location /Schedules/ {
		add_header Cache-Control no-store;
		#limit_req zone=session_limit burst=5;
		rewrite_by_lua_file "/usr/local/openresty/nginx/conf/conf.d/rewitre_token_check.lua";
		access_by_lua_file "/usr/local/openresty/nginx/conf/conf.d/access_session.lua";
		proxy_pass http://Schedules;
		client_max_body_size    1000m;
		proxy_cache cache_one;
		limit_rate 200k;
  	}
	location /StdImportExport/ {
		add_header Cache-Control no-store;
		#limit_req zone=session_limit burst=5;
		rewrite_by_lua_file "/usr/local/openresty/nginx/conf/conf.d/rewitre_token_check.lua";
		access_by_lua_file "/usr/local/openresty/nginx/conf/conf.d/access_session.lua";
		proxy_pass http://StdImportExport;
		client_max_body_size    1000m;
		proxy_cache cache_one;
		limit_rate 200k;
  	}
	location /SupperManage/ {
		add_header Cache-Control no-store;
		#limit_req zone=session_limit burst=5;
		rewrite_by_lua_file "/usr/local/openresty/nginx/conf/conf.d/rewitre_token_check.lua";
		access_by_lua_file "/usr/local/openresty/nginx/conf/conf.d/access_session.lua";
		proxy_pass http://SupperManage;
		client_max_body_size    1000m;
		proxy_cache cache_one;
		limit_rate 200k;
  	}
	location /TestController/ {
		add_header Cache-Control no-store;
		#limit_req zone=session_limit burst=5;
		rewrite_by_lua_file "/usr/local/openresty/nginx/conf/conf.d/rewitre_token_check.lua";
		access_by_lua_file "/usr/local/openresty/nginx/conf/conf.d/access_session.lua";
		proxy_pass http://TestController;
		client_max_body_size    1000m;
		proxy_cache cache_one;
		limit_rate 200k;
  	}
	location /TestPlan/ {
		add_header Cache-Control no-store;
		#limit_req zone=session_limit burst=5;
		rewrite_by_lua_file "/usr/local/openresty/nginx/conf/conf.d/rewitre_token_check.lua";
		access_by_lua_file "/usr/local/openresty/nginx/conf/conf.d/access_session.lua";
		proxy_pass http://TestPlan;
		client_max_body_size    1000m;
		proxy_cache cache_one;
		limit_rate 200k;
  	}
	location /Update/ {
		add_header Cache-Control no-store;
		#limit_req zone=session_limit burst=5;
		rewrite_by_lua_file "/usr/local/openresty/nginx/conf/conf.d/rewitre_token_check.lua";
		access_by_lua_file "/usr/local/openresty/nginx/conf/conf.d/access_session.lua";
		proxy_pass http://Update;
		client_max_body_size    1000m;
		proxy_cache cache_one;
		limit_rate 200k;
  	}
	location /Video/ {
		add_header Cache-Control no-store;
		#limit_req zone=session_limit burst=5;
		rewrite_by_lua_file "/usr/local/openresty/nginx/conf/conf.d/rewitre_token_check.lua";
		access_by_lua_file "/usr/local/openresty/nginx/conf/conf.d/access_session.lua";
		proxy_pass http://Video;
		client_max_body_size    1000m;
		proxy_cache cache_one;
		limit_rate 200k;
  	}
	location /admin/ {
		add_header Cache-Control no-store;
		#limit_req zone=session_limit burst=5;
		rewrite_by_lua_file "/usr/local/openresty/nginx/conf/conf.d/rewitre_token_check.lua";
		access_by_lua_file "/usr/local/openresty/nginx/conf/conf.d/access_session.lua";
		proxy_pass http://admin;
		client_max_body_size    1000m;
		proxy_cache cache_one;
		limit_rate 200k;
  	}
	location /afterLoginController/ {
		add_header Cache-Control no-store;
		#limit_req zone=session_limit burst=5;
		rewrite_by_lua_file "/usr/local/openresty/nginx/conf/conf.d/rewitre_token_check.lua";
		access_by_lua_file "/usr/local/openresty/nginx/conf/conf.d/access_session.lua";
		proxy_pass http://afterLoginController;
		client_max_body_size    1000m;
		proxy_cache cache_one;
		limit_rate 200k;
  	}
	location /appInfo/ {
		add_header Cache-Control no-store;
		#limit_req zone=session_limit burst=5;
		rewrite_by_lua_file "/usr/local/openresty/nginx/conf/conf.d/rewitre_token_check.lua";
		access_by_lua_file "/usr/local/openresty/nginx/conf/conf.d/access_session.lua";
		proxy_pass http://appInfo;
		client_max_body_size    1000m;
		proxy_cache cache_one;
		limit_rate 200k;
  	}
	location /appMessage/ {
		add_header Cache-Control no-store;
		#limit_req zone=session_limit burst=5;
		rewrite_by_lua_file "/usr/local/openresty/nginx/conf/conf.d/rewitre_token_check.lua";
		access_by_lua_file "/usr/local/openresty/nginx/conf/conf.d/access_session.lua";
		proxy_pass http://appMessage;
		client_max_body_size    1000m;
		proxy_cache cache_one;
		limit_rate 200k;
  	}
	location /indexController/ {
		add_header Cache-Control no-store;
		#limit_req zone=session_limit burst=5;
		rewrite_by_lua_file "/usr/local/openresty/nginx/conf/conf.d/rewitre_token_check.lua";
		access_by_lua_file "/usr/local/openresty/nginx/conf/conf.d/access_session.lua";
		proxy_pass http://indexController;
		client_max_body_size    1000m;
		proxy_cache cache_one;
		limit_rate 200k;
  	}
	location /public/ {
		add_header Cache-Control no-store;
		#limit_req zone=session_limit burst=5;
		rewrite_by_lua_file "/usr/local/openresty/nginx/conf/conf.d/rewitre_token_check.lua";
		access_by_lua_file "/usr/local/openresty/nginx/conf/conf.d/access_session.lua";
		proxy_pass http://public;
		client_max_body_size    1000m;
		proxy_cache cache_one;
		limit_rate 200k;
  	}
	location /webroot/ {
		add_header Cache-Control no-store;
		#limit_req zone=session_limit burst=5;
		rewrite_by_lua_file "/usr/local/openresty/nginx/conf/conf.d/rewitre_token_check.lua";
		access_by_lua_file "/usr/local/openresty/nginx/conf/conf.d/access_session.lua";
		proxy_pass http://webroot;
		client_max_body_size    1000m;
		proxy_cache cache_one;
		limit_rate 200k;
  	}
	location /www/ {
		add_header Cache-Control no-store;
		#limit_req zone=session_limit burst=5;
		rewrite_by_lua_file "/usr/local/openresty/nginx/conf/conf.d/rewitre_token_check.lua";
		access_by_lua_file "/usr/local/openresty/nginx/conf/conf.d/access_session.lua";
		proxy_pass http://www;
		client_max_body_size    1000m;
		proxy_cache cache_one;
		limit_rate 200k;
  	}
	location /zuxia/ {
		add_header Cache-Control no-store;
		#limit_req zone=session_limit burst=5;
		rewrite_by_lua_file "/usr/local/openresty/nginx/conf/conf.d/rewitre_token_check.lua";
		access_by_lua_file "/usr/local/openresty/nginx/conf/conf.d/access_session.lua";
		proxy_pass http://zuxia;
		client_max_body_size    1000m;
		proxy_cache cache_one;
		limit_rate 200k;
  	}
	

	location /auth_token {
		limit_req zone=token_limit burst=1;
     		if ($arg_url = "") {
         		return 403;
     		}
     		access_by_lua '
			local random = ngx.var.cookie_NOONLY_KEY
                        if (random == nil) then
                                random = ngx.md5(math.random(9999) .. os.time() .. math.random(9999) .. ngx.var.remote_addr)
                        end
                        local token = ngx.md5("Ntoken" .. random .. "NT123456NT" .. random)
                        if (ngx.var.cookie_NOONLY_ACCESS ~= token) then
                                ngx.header["Set-Cookie"] = {"NOONLY_ACCESS=" .. token, "NOONLY_KEY=" .. random}
                                return ngx.redirect(ngx.var.arg_url)
                        end

     		';
	}
	
	location /myprofile {
		limit_req zone=token_limit burst=1;
		default_type 'text/html';
		access_by_lua_file "/usr/local/openresty/nginx/conf/conf.d/myprofile.lua";
	}

	location /upload {
		default_type 'text/html';
		client_max_body_size    1000m;
                content_by_lua_file "/usr/local/openresty/nginx/conf/conf.d/test.lua";
        }

	location /data/ {
		root /tmp/;
	}

	location /v/ {
                root /video/;
        }

	location /valid {
                set $arg_c unkonw;
                set $arg_flag "flag=sign";
                limit_req zone=token_limit burst=1;
                default_type 'text/html';
                access_by_lua_file "/usr/local/openresty/nginx/conf/conf.d/valid.lua";
                proxy_pass http://172.17.0.29:9090/plugins/createStd/createstudents?$args&$arg_c&$arg_flag;
        }

        location /forgotPassword {
                set $arg_c unkonw;
                set $arg_flag "flag=forgot";
                limit_req zone=token_limit burst=1;
                default_type 'text/html';
                access_by_lua_file "/usr/local/openresty/nginx/conf/conf.d/valid.lua";
                proxy_pass http://172.17.0.29:9090/plugins/createStd/createstudents?$args&$arg_c&$arg_flag;
        }
     	#location /redis {
	#	limit_req zone=auth_limit burst=1;
        #	default_type 'text/html';
        #	access_by_lua_file "/usr/local/openresty/nginx/conf/conf.d/access_by_redis.lua";
   	#}
}
